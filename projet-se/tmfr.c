/** \file
 * tmfr.c : teste le maquefilereader
 * \copyright Vincent Loechner, 2014.
 */
#include <unistd.h>
#include <stdlib.h>
#include <stdio.h>

#include "maquefilereader.h"

/** main
 * ouvre un fichier maquefile passé en argument, l'analyse et construit
 * la première cible ou le cas échéant la cible passée en argument.
 */
int main( int argc, char **argv )
{
	char *maquefile="maquefile"; /* nom du maquefile par défaut */
	int numproc = 1;
	int opt;
	Noeud *ncible;

	/* analyse des arguments */
	while( (opt=getopt( argc, argv, "j:f:")) != -1 )
	{
		switch( opt )
		{
			case 'j':
				numproc = atoi(optarg);
				break;
			case 'f':
				maquefile = optarg;
				break;
			default:
				fprintf( stderr,
					"Usage: %s [-j nbthreads] [-f filename] [target]\n",
					argv[0] );
				exit(2);
		}
	}

	/* lecture du maquefile */
	Graphe *g;
	g = LireMaquefile( maquefile );
	if( g == NULL )
		exit( 1 );

	/* target */
	if( optind >= argc )
	{
		/* pas de cible spécifiée,
		 * on prend la dernière de la liste des noeuds du graphe */
		Graphe *tmp;
		for( tmp=g ; tmp->suiv != NULL ; tmp=tmp->suiv )
			;
		ncible = tmp->n;
	}
	else
	{
		/* on cherche la cible spécifiée */
		char *target;
		target = argv[optind];
		if( (ncible = TrouveNoeud(g, target )) == NULL )
		{
			fprintf( stderr, "No rule to make target '%s'.\n", target );
			exit( 2 );
		}
	}

	printf( "Making. Number of procs: %d; maquefile: %s; target:%s\n",
			numproc, maquefile, ncible->nom );

	AfficheGraphe( g );

	FreeGraphe( g );

	return( 0 );
}
