/** \file
 * tmfr.c : teste le maquefilereader
 * \copyright Vincent Loechner, 2014.
 */
#include <unistd.h>
#include <stdlib.h>
#include <stdio.h>
#include <sys/wait.h>

#include "maquefilereader.h"

/** main
 * ouvre un fichier maquefile passé en argument, l'analyse et construit
 * la première cible ou le cas échéant la cible passée en argument.
 */

Noeud* executer(Noeud* n){
	int i = 0;
	int pid;
	int status;
	//
	while((n->commandes != NULL) && (n->commandes[i])){
		pid = fork();
		//execution des commandes dans le fils
		if(pid > 0){
			execl("/bin/sh", "/bin/sh", "-c", n->commandes[i], NULL);
		}	
		//sinon on attend (père)
		else{
			waitpid(pid, &status, 0);
			n->flag += 1;
		}
		i++;
	}
	return n;	
}

Graphe* maqueGeneral(Graphe *tmp){
	//variable permettant de définir la fin de la boucle
	int fb = 0;
	//tant qu'il y a des noeuds a analyser
	while(fb != 1){
		//id du premier fork
		int pid;
		int status;	
		pid = fork();
		switch(pid){
			case -1: 	
				perror("Erreur lors de l'exécution du fork");
				break;
			case 0:
				tmp->n = executer(tmp->n);
				exit(1);
				break;
			//Attendre la fin du fils avant de passer au noeud suivant
			default:
				sleep(1);
				waitpid(pid, &status, 0);
				break;
 		}
 		//passage au noeud suivant
		if(tmp->suiv != NULL)
			tmp=tmp->suiv;
		else
			fb = 1;
		}
		return tmp;
}

Noeud* maqueSpecifique(Noeud* node){
	if(node->pred == NULL){
		node = executer(node);
	}
	else{
		Liste* p = node->pred;
		int fb = 0;
		int testExec = 1;
		while(fb == 0){
			if(p->n->flag == 0){
				testExec = 0;
				maqueSpecifique(p->n);
			}
			if(p->suiv != NULL)
				p = p->suiv;
			else
				fb = 1;
		}
		if(testExec == 0){
			node = executer(node);
			sleep(1);
		}
	}
	return node;
}



int main( int argc, char **argv )
{
	char *maquefile="Maquefile.test3"; /* nom du maquefile par défaut */
	int numproc = 1;
	int opt;
	Noeud *ncible;

	/* analyse des arguments */
	while( (opt=getopt( argc, argv, "j:f:")) != -1 )
	{
		switch( opt )
		{
			case 'j':
				numproc = atoi(optarg);
				break;
			case 'f':
				maquefile = optarg;
				break;
			default:
				fprintf( stderr,
					"Usage: %s [-j nbthreads] [-f filename] [target]\n",
					argv[0] );
				exit(2);
		}
	}

	/* lecture du maquefile */
	Graphe *g;
	g = LireMaquefile( maquefile );
	if( g == NULL )
		exit( 1 );

	/* target */
	if( optind >= argc )
	{
		/* pas de cible spécifiée,
		 * on prend la dernière de la liste des noeuds du graphe */
		Graphe *tmp;
		tmp=g;
		tmp = maqueGeneral(tmp);
		ncible = tmp->n;
	}
	else
	{
		/* on cherche la cible spécifiée */
		char *target;
		target = argv[optind];
		if( (ncible = TrouveNoeud(g, target )) == NULL )
		{
			fprintf( stderr, "No rule to make target '%s'.\n", target );
			exit( 2 );
		}
		else{
				ncible = maqueSpecifique(ncible);
		}
	}

	printf( "Making. Number of procs: %d; maquefile: %s; target:%s\n",
			numproc, maquefile, ncible->nom );

	//AfficheGraphe( g );

	FreeGraphe( g );

	return( 0 );
}
